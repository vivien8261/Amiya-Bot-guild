<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link type="text/css" rel="styleSheet" href="../assets/font/font.css"/>
    <link type="text/css" rel="styleSheet" href="userInfo.css"/>
    <title>template</title>
</head>
<body>
<div id="template">
    <div class="card-content" v-if="Object.keys(data).length">
        <div class="background"></div>
        <div class="base-info">
            <div class="avatar">
                <img :src="data.avatar" :alt="data.nickname">
                <span>{{ data.nickname }}</span>
            </div>
            <div class="info">
                <div>今日{{ data.user_info.sign_in ? '已' : '未' }}签到</div>
                <div>累计签到：{{ data.user_info.sign_times }}</div>
                <div>阿米娅的信赖值：{{ (data.user_info.user_feeling / 10).toFixed(0) }}%</div>
                <div>阿米娅的心情值：{{ (data.user_info.user_mood / 15 * 100).toFixed(0) }}%</div>
            </div>
            <div>
                <div>剩余合成玉：{{ data.user_info.jade_point }}</div>
                <div>今日已获取合成玉：{{ data.user_info.jade_point_max }}/30000</div>
                <div class="jade-point">
                    <div class="block"
                         :style="{ width: (data.user_info.jade_point_max / 30000 * 100).toFixed(0) + '%' }">
                    </div>
                </div>
            </div>
        </div>
        <div class="gacha-info">
            <div>干员拥有数：{{ operatorNum }}</div>
            <div>剩余寻访凭证：{{ data.user_gacha_info.coupon }}</div>
            <div>已经抽取了 <span class="mark">{{ data.user_gacha_info.gacha_break_even }}</span> 次而未获得六星干员</div>
            <div>抽卡总次数：{{ total }}</div>
            <div class="pie" ref="pie"></div>
        </div>
        <div class="barcode">
            <canvas ref="barcode"></canvas>
        </div>
    </div>
</div>
</body>
<script src="../vue.min.js"></script>
<script src="../echarts.min.js"></script>
<script src="../JsBarcode.all.min.js"></script>
<script>
    const template = new Vue({
        el: '#template',
        methods: {
            init(data) {
                const box = data.operator_box.operator.split('|').filter(n => n)
                const rate = {}
                const res = []

                let total = 0
                for (let item of box) {
                    let opt = item.split(':')

                    if (!rate[opt[1]]) {
                        rate[opt[1]] = 0
                    }
                    rate[opt[1]] += parseInt(opt[2])
                    total += parseInt(opt[2])
                }

                const colors = {
                    '3': '#67c23a',
                    '4': '#5470c6',
                    '5': '#fac858',
                    '6': '#ee6665'
                }

                for (let r in rate) {
                    let value = (rate[r] / total * 100).toFixed(2)
                    res.push(
                        {
                            value: value,
                            name: `${r}星概率\n${value}%`,
                            itemStyle: {
                                color: colors[r]
                            }
                        }
                    )
                }

                this.$set(this, 'data', data)
                this.$nextTick(() => {
                    this.setCharts(res)
                    this.total = total
                    this.operatorNum = box.length
                    JsBarcode(this.$refs.barcode, data.user.user_id, {
                        background: 'transparent',
                        lineColor: 'rgba(255, 255, 255, .5)',
                        displayValue: false
                    })
                })
            },
            setCharts(data) {
                const charts = echarts.init(this.$refs.pie)
                const option = {
                    animation: false,
                    series: [
                        {
                            type: 'pie',
                            radius: ['40%', '70%'],
                            data: data,
                            minAngle: 10,
                            itemStyle: {
                                borderRadius: 4,
                                borderColor: '#fff',
                                borderWidth: 1
                            }
                        }
                    ]
                }
                charts.setOption(option)
            }
        },
        data() {
            return {
                data: {},
                total: 0,
                operatorNum: 0
            }
        },
        mounted() {
            window.init = this.init
        }
    })
</script>
</html>
